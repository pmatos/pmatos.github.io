<!doctype html><html lang="it"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Cross-Arch Reproducibility using Containers - pmatos rambles</title><meta name="description" content="Use of containers for cross architecture reproducibility using `docker` and `podman`, which I then go on to apply to JSC. "><meta name="keywords" content=""><meta name="creation_Date" content="06/07/2022"><meta name="robots" content="index, follow"><meta name="author" content="Paulo Matos"><link rel="preconnect" href="https://fonts.gstatic.com/"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Roboto+Serif:wght@300;400;500;600;700;800&subset=latin-ext&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Serif:wght@300;400;500;600;700;800&subset=latin-ext&display=swap" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Serif:wght@300;400;500;600;700;800&subset=latin-ext&display=swap"></noscript><link rel="preload" href="/css/style.css" as="style"><link rel="stylesheet" href="/css/style.css" media="all"><link rel="sitemap" type="application/rss+xml" title="RSS Feed for pmatos rambles " href="/feed.xml"><link rel="shortcut icon" href="/favicon/favicon.ico" sizes="any"><link rel="icon" type="image/svg+xml" href="/favicon/safari-pinned-tab.svg"><meta property="og:type" content="article"><meta property="og:locale" content="en-US"><meta property="og:image" content="https://p.ocmatos.com /img/social/cross-arch-reproducibility-using-containers .png "><meta property="og:image:width" content="1280"><meta property="og:image:height" content="720"><meta property="og:title" content="Cross-Arch Reproducibility using Containers  - pmatos rambles "><meta property="og:description" content="Use of containers for cross architecture reproducibility using `docker` and `podman`, which I then go on to apply to JSC. "><meta property="og:url" content="https://p.ocmatos.com"><meta property="og:image:alt" content="Immagine per la condivisione sui social"><meta property="fb:admins" content=""><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><meta name="twitter:url" content=""><meta name="twitter:title" content="Cross-Arch Reproducibility using Containers  - pmatos rambles "><meta name="twitter:description" content="Use of containers for cross architecture reproducibility using `docker` and `podman`, which I then go on to apply to JSC. "><meta name="twitter:image:src" content="https://p.ocmatos.com /img/social/cross-arch-reproducibility-using-containers .png"><meta name="twitter:image:alt" content="pmatos rambles  logo"><link rel="manifest" href="/manifest.webmanifest"><meta name="apple-mobile-web-app-title" content="pmatos rambles"><meta name="application-name" content="pmatos rambles"><meta name="msapplication-TileColor" content="#000000"><meta name="theme-color" content="#000000"><link rel="shortcut icon" href="/favicon/favicon.ico"><link rel="icon" type="image/svg+xml" href="/favicon/safari-pinned-tab.svg"><link rel="icon" type="image/png" sizes="196x196" href="/favicon/favicon-196.png"><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-square70x70logo" content="/favicon/mstile-icon-128.png"><meta name="msapplication-square150x150logo" content="/favicon/mstile-icon-270.png"><meta name="msapplication-square310x310logo" content="/favicon/mstile-icon-558.png"><meta name="msapplication-wide310x150logo" content="/favicon/mstile-icon-558-270.png"><meta name="apple-mobile-web-app-capable" content="yes"><link rel="apple-touch-icon" href="/favicon/apple-icon-180.png"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2048-2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2732-2048.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1668-2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2388-1668.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1536-2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2048-1536.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1668-2224.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2224-1668.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1620-2160.png" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2160-1620.png" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1284-2778.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2778-1284.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1170-2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2532-1170.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1125-2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2436-1125.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1242-2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2688-1242.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-828-1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1792-828.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1242-2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-2208-1242.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-750-1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1334-750.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-640-1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/favicon/apple-splash-1136-640.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet"><script>if ("serviceWorker" in navigator)
            navigator.serviceWorker.register("/sw.js");</script><script type="application/ld+json">{
            "@context": "http://schema.org",
            "@type": "NewsArticle",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https://p.ocmatos.com/blog/cross-arch-reproducibility-using-containers.html"
            },
            "headline": "Cross-Arch Reproducibility using Containers - pmatos rambles",
            "image": [
                "https://p.ocmatos.com/img/social/cross-arch-reproducibility-using-containers.png"
            ],
            "datePublished": "Thu Jan 16 2020 00:00:00 GMT+0000 (Coordinated Universal Time)",
            "dateModified": "Thu Jan 16 2020 00:00:00 GMT+0000 (Coordinated Universal Time)",
            "author": {
                "@type": "Person",
                "name": "Paulo Matos"
            },
            "publisher": {
                "@type": "Organization",
                "name": "pmatos rambles",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://p.ocmatos.comimg/avatar.webpg"
                }
            },
            "description": "Use of containers for cross architecture reproducibility using `docker` and `podman`, which I then go on to apply to JSC."
        }</script></head><body><header><hgroup><p class="title">pmatos rambles</p><p class="motto">Programming, sports and music - oh wow - enjoy!</p><p></p></hgroup><nav><ul><li><a href="/">Home</a></li><li><a href="/about-me.html">About me</a></li><li><a href="/blog.html">Blog</a></li></ul></nav></header><article><small class="info"><time datetime="Thu Jan 16 2020 00:00:00 GMT+0000 (Coordinated Universal Time)">16 Jan 2020</time>&nbsp;&ndash;&nbsp; &lt;h2&gt;Introduction&lt;/h2&gt; &lt;p&gt;Part of my work for Igalia is on the 32bit support on MIPS (little endian) and ARM for JSC (JavaScriptCore - the JavaScript compiler in WebKit) and one of the problems we face is that of reproducibility of failures.&lt;/p&gt; &lt;p&gt;We have boards to test these, namely Raspberry Pi 3 Model B+ boards, running a 32bits ARM kernel and Imagination CI20 boards running a mipsel kernel - all built with buildroot which provides images for these boards out-of-the-box. However, we don&#39;t work on these - most of us have higher performance x86_64 machines and whenever a failure occurs upstream it&#39;s generally time consuming to reproduce.&lt;/p&gt; &lt;p&gt;I have therefore set out to create an environment where we can easily reproduce cross-architectural failures on JSC. I had worked on similar issues for &lt;a href=&quot;https://racket-lang.org&quot;&gt;Racket&lt;/a&gt;, when building the cross-architectural Racket chroot environment on GitLab CI.&lt;/p&gt; &lt;h2&gt;Starting with chroot&lt;/h2&gt; &lt;p&gt;Let&#39;s start the discussion by talking about &lt;code&gt;chroot&lt;/code&gt;. In any linux system you&#39;ll find a &lt;code&gt;chroot&lt;/code&gt; binary.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;which&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt;&lt;br&gt;/usr/sbin/chroot&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--help&lt;/span&gt;&lt;br&gt;Usage: &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;OPTION&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; NEWROOT &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;COMMAND &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ARG&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;.&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;br&gt; or: &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; OPTION&lt;br&gt;Run COMMAND with root directory &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; to NEWROOT.&lt;br&gt;&lt;br&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--groups&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;G_LIST specify supplementary &lt;span class=&quot;token function&quot;&gt;groups&lt;/span&gt; as g1,g2,&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;,gN&lt;br&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--userspec&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token environment constant&quot;&gt;USER&lt;/span&gt;:GROUP specify user and group &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ID or name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; to use&lt;br&gt; --skip-chdir &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; not change working directory to &lt;span class=&quot;token string&quot;&gt;&#39;/&#39;&lt;/span&gt;&lt;br&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--help&lt;/span&gt; display this &lt;span class=&quot;token builtin class-name&quot;&gt;help&lt;/span&gt; and &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt;&lt;br&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--version&lt;/span&gt; output version information and &lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt;&lt;br&gt;&lt;br&gt;If no &lt;span class=&quot;token builtin class-name&quot;&gt;command&lt;/span&gt; is given, run &lt;span class=&quot;token string&quot;&gt;&#39;&quot;$SHELL&quot; -i&#39;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;default: &lt;span class=&quot;token string&quot;&gt;&#39;/bin/sh -i&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;.&lt;br&gt;&lt;br&gt;GNU coreutils online help: &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;https://www.gnu.org/software/coreutils/&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;br&gt;Full documentation at: &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;https://www.gnu.org/software/coreutils/chroot&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;br&gt;or available locally via: info &lt;span class=&quot;token string&quot;&gt;&#39;(coreutils) chroot invocation&#39;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;However, at a slightly lower level, &lt;a href=&quot;http://man7.org/linux/man-pages/man2/chroot.2.html&quot;&gt;&lt;code&gt;chroot&lt;/code&gt;&lt;/a&gt; is a system call.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;man&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-s2&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt;&lt;br&gt;CHROOT&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;br&gt;NAME&lt;br&gt; &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; - change root directory&lt;br&gt;&lt;br&gt;SYNOPSIS&lt;br&gt; &lt;span class=&quot;token comment&quot;&gt;#include &amp;lt;unistd.h&gt;&lt;/span&gt;&lt;br&gt;&lt;br&gt; int chroot&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;const char *path&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;br&gt; Feature Test Macro Requirements &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; glibc &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;see feature_test_macros&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;))&lt;/span&gt;:&lt;br&gt;&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;.&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;As mentioned in the man page, it changes the root of the file system for a process to the path passed as argument. This new environment created for the process is known as a chroot jail, to which we will refer simply as a &lt;em&gt;jail&lt;/em&gt;.&lt;/p&gt; &lt;p&gt;The jail allows us to trap a process inside a filesystem, i.e. the process cannot access anything outside the filesystem it is in. So, if it tried to access the root of the filesystem, inside the jail it will only see the root of the new file system which is the path we passed on to &lt;code&gt;chroot&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;As an example throughout the post I will be using the factorial function. Whenever I refer to &lt;code&gt;factorial.c&lt;/code&gt;, I refer to a file that you might have to create as needed and consists of the following C source code.&lt;/p&gt; &lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdint.h&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;inttypes.h&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;br&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; argc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;br&gt;&lt;br&gt; &lt;span class=&quot;token class-name&quot;&gt;uint64_t&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;br&gt; &lt;span class=&quot;token class-name&quot;&gt;uint32_t&lt;/span&gt; arg&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;br&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;argc &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;br&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;br&gt; arg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;strtoul&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;br&gt; &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arg&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;*=&lt;/span&gt; arg&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;br&gt; &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Result: %&quot;&lt;/span&gt; PRIu64 &lt;span class=&quot;token string&quot;&gt;&quot;&#92;n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;br&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;Let&#39;s compile it and run an example.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ gcc &lt;span class=&quot;token parameter variable&quot;&gt;-Wall&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-Wextra&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-o&lt;/span&gt; factorial factorial.c&lt;br&gt;$ ./factorial &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;br&gt;Result: &lt;span class=&quot;token number&quot;&gt;2432902008176640000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;Let&#39;s create a jail for this binary using &lt;code&gt;chroot&lt;/code&gt; and run it.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; jail&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; factorial jail/&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; jail/ /factorial&lt;br&gt;chroot: cannot change root directory to &lt;span class=&quot;token string&quot;&gt;&#39;jail/&#39;&lt;/span&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;:&lt;/span&gt; Operation not permitted&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;First lesson here: only &lt;code&gt;root&lt;/code&gt; can &lt;code&gt;chroot&lt;/code&gt;. For security reasons, a normal user cannot &lt;code&gt;chroot&lt;/code&gt;. Being able to do so, would allow the user privilege escalation (&lt;a href=&quot;https://web.archive.org/web/20160127150916/http://www.bpfh.net/simes/computing/chroot-break.html&quot;&gt;further details&lt;/a&gt; on breaking out of the chroot jail and privilege escalation).&lt;/p&gt; &lt;p&gt;So we &lt;code&gt;sudo&lt;/code&gt;:&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; jail/ /factorial&lt;br&gt;chroot: failed to run &lt;span class=&quot;token builtin class-name&quot;&gt;command&lt;/span&gt; ‘/factorial’: No such &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; or directory&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;Now this really starts to annoy you and you start wondering if the path to &lt;code&gt;factorial&lt;/code&gt; is correct. It is correct, the path is relative to the jail root. Once the root becomes &lt;code&gt;jail/&lt;/code&gt;, the &lt;code&gt;factorial&lt;/code&gt; binary is in the root of the filesystem so &lt;code&gt;/factorial&lt;/code&gt; is correct. The problem is subtle but will teach you an important lesson: dependencies. This is, after all, a dynamically linked executable 💡.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ ldd factorial&lt;br&gt; linux-vdso.so.1 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x00007ffe1f7f9000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;br&gt; libc.so.6 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; /lib/x86_64-linux-gnu/libc.so.6 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x00007f65bf62e000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;br&gt; /lib64/ld-linux-x86-64.so.2 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0x00007f65bf844000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;Those files exist in your file system, but not in the jail, so you get an error (although a pretty terrible error message at that). Let&#39;s try a static executable instead.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ gcc &lt;span class=&quot;token parameter variable&quot;&gt;-Wall&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-Wextra&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-static&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-o&lt;/span&gt; factorial factorial.c&lt;br&gt;$ ldd factorial&lt;br&gt; not a dynamic executable&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; jail/ /factorial &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;br&gt;Result: &lt;span class=&quot;token number&quot;&gt;2432902008176640000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;This is exactly what we wanted from the beginning - to show that the binary is now jailed in this root and cannot escape without explicitly trying to, something no benign binary is likely to do (see my comment above on escaping jail).&lt;/p&gt; &lt;p&gt;In chroot jails, the filesystem root changes but it&#39;s still running on the same kernel. This allows us to create a new userspace inside this jail, separate from the host&#39;s, and possibly based on a different linux distribution. For reproducibility, you can potentially tarball this jail and send it to someone else, who could themselves &lt;code&gt;chroot&lt;/code&gt; into it and reproduce a specific problem.&lt;/p&gt; &lt;h2&gt;QEMU and binfmt&lt;/h2&gt; &lt;p&gt;I will now introduce two other essential components to achieve our goal of cross architecture reproducibility: QEMU and binfmt.&lt;/p&gt; &lt;p&gt;Up until now our jail has contained binaries compiled for our host architecture (in my case x86_64), however this need not be the case. &lt;a href=&quot;https://www.qemu.org&quot;&gt;QEMU&lt;/a&gt; is an open-source hardware emulator and virtualizer. It implements two execution modes: system mode, and user mode;&lt;/p&gt; &lt;p&gt;In system mode, QEMU works like &lt;a href=&quot;https://www.virtualbox.org&quot;&gt;VirtualBox&lt;/a&gt; it emulates a whole system - from the applications, interrupts, and kernel, all the way to the hardware devices. The one I am interested in is user mode. In user mode, QEMU emulates a single binary leaving the rest of the system untouched.&lt;/p&gt; &lt;p&gt;To demo how it works, lets use a cross-toolchain to compile a program to be run on a different architecture. Given I am on a &lt;code&gt;x86_64&lt;/code&gt;, I will use an &lt;code&gt;armhf&lt;/code&gt; toolchain. You can either download one provided from your distro or compile one with &lt;a href=&quot;https://crosstool-ng.github.io/&quot;&gt;crosstool-ng&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;For the sake of reproducibility, lets compile a pre-configured one with &lt;code&gt;crosstool-ng&lt;/code&gt;. Download it and install it in &lt;code&gt;$PATH&lt;/code&gt; - I used version 1.24.0. Then build the cross toolchain for &lt;code&gt;armv7-rpi2-linux-gnueabihf&lt;/code&gt;.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; build&lt;br&gt;$ &lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; build&lt;br&gt;build/ $ ct-ng armv7-rpi2-linux-gnueabihf&lt;br&gt;build/ $ ct-ng build&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;Let&#39;s once again compile the &lt;code&gt;factorial.c&lt;/code&gt; example, but this time with our new toolchain. This toolchain will be in &lt;code&gt;$HOME/x-tools/armv7-rpi2-linux-gnueabihf&lt;/code&gt; by default.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;&lt;span class=&quot;token environment constant&quot;&gt;PATH&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token environment constant&quot;&gt;$HOME&lt;/span&gt;/x-tools/armv7-rpi2-linux-gnueabihf/bin:&lt;span class=&quot;token environment constant&quot;&gt;$PATH&lt;/span&gt;&lt;br&gt;$ armv7-rpi2-linux-gnueabihf-gcc &lt;span class=&quot;token parameter variable&quot;&gt;-static&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-o&lt;/span&gt; factorial factorial.c&lt;br&gt;$ ./factorial&lt;br&gt;zsh: &lt;span class=&quot;token builtin class-name&quot;&gt;exec&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;format&lt;/span&gt; error: ./factorial&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; factorial&lt;br&gt;factorial: ELF &lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;-bit LSB executable, ARM, EABI5 version &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SYSV&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;, &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;&lt;br&gt;dynamically linked, interpreter /lib/ld-linux-armhf.so.3, &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; GNU/Linux &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;token number&quot;&gt;4.19&lt;/span&gt;.21, with debug_info, not stripped&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;We were expecting this error, right? After all, we cannot just execute an arm binary in a x86_64 system. However, we can if we use QEMU in user mode which is what I want to show:&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ qemu-arm ./factorial &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt; &lt;br&gt;Result: &lt;span class=&quot;token number&quot;&gt;2432902008176640000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;Now we have it working - however, there&#39;s a last tool we need to discuss and that&#39;s &lt;code&gt;binfmt&lt;/code&gt;. &lt;code&gt;binfmt_misc&lt;/code&gt; is a linux kernel capability that allows arbitrary executable file formats to be recognized and passed on to an interpreter. This means that we can transparently recognize arm (or any other architecture) executables and request them to be passed to QEMU transparently when we try to execute them.&lt;/p&gt; &lt;p&gt;Before proceeding, if you wish to follow the examples, verify that your kernel has &lt;code&gt;binfmt&lt;/code&gt; enabled.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ zcat /proc/config.gz&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; BINFMT&lt;br&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;CONFIG_BINFMT_ELF&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;y&lt;br&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;CONFIG_COMPAT_BINFMT_ELF&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;y&lt;br&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;CONFIG_BINFMT_SCRIPT&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;y&lt;br&gt;&lt;span class=&quot;token assign-left variable&quot;&gt;CONFIG_BINFMT_MISC&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;y&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;If you don&#39;t have &lt;code&gt;/proc/config.gz&lt;/code&gt; try instead &lt;code&gt;grep BINFMT /boot/config-$(uname -r)&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;Let&#39;s go back to our factorial on arm example, but this time install a &lt;code&gt;binfmt&lt;/code&gt; record to call &lt;code&gt;qemu-arm&lt;/code&gt; on the executable whenever we try to execute it directly. A &lt;code&gt;binfmt&lt;/code&gt; record looks like &lt;code&gt;:name:type:offset:magic:mask:interpreter:flags&lt;/code&gt; and needs to be installed by echoing the correct string to &lt;code&gt;/proc/sys/fs/binfmt_misc/register&lt;/code&gt;. For details on this consult the &lt;a href=&quot;https://www.kernel.org/doc/html/latest/admin-guide/binfmt-misc.html&quot;&gt;kernel documentation&lt;/a&gt;. For &lt;code&gt;armv7&lt;/code&gt; we can register our interpreter and run our binary transparently like this:&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bash&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;echo &quot;:qemu-arm:M:0:&#92;&#92;x7f&#92;&#92;x45&#92;&#92;x4c&#92;&#92;x46&#92;&#92;x01&#92;&#92;x01&#92;&#92;x01&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&lt;br&gt;&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x02&#92;&#92;x00&#92;&#92;x28&#92;&#92;x00:&#92;&#92;xff&#92;&#92;xff&#92;&#92;xff&#92;&#92;xff&#92;&#92;xff&#92;&#92;xff&#92;&#92;xff&#92;&#92;x00&#92;&#92;xff&#92;&#92;xff&#92;&#92;xff&#92;&#92;xff&#92;&#92;xff&#92;&lt;br&gt;&#92;&#92;xff&#92;&#92;xff&#92;&#92;xff&#92;&#92;xfe&#92;&#92;xff&#92;&#92;xff&#92;&#92;xff:/home/pmatos/installs/bin/qemu-arm:OCF&quot; &gt; &#92;&lt;br&gt;/proc/sys/fs/binfmt_misc/register&#39;&lt;/span&gt;&lt;br&gt;$ ./factorial &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;br&gt;Result: &lt;span class=&quot;token number&quot;&gt;2432902008176640000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;The write to &lt;code&gt;/proc/sys/fs/binfmt_misc/register&lt;/code&gt; may fail if you already have a record for &lt;code&gt;qemu-arm&lt;/code&gt; setup. To remove the record run &lt;code&gt;echo -1 &amp;gt; /proc/sys/fs/binfmt_misc/qemu-arm&lt;/code&gt;. Note that the file, as shown above is an ARM binary and yet we transparently run it through QEMU thanks to the &lt;code&gt;binfmt&lt;/code&gt; magic we have initially set up.&lt;/p&gt; &lt;p&gt;I should note, that while interesting to understand how this works behind the scenes, several people have created images to do the binfmt registration for you. One of those projects is &lt;a href=&quot;https://hub.docker.com/r/docker/binfmt/tags&quot;&gt;docker/binfmt&lt;/a&gt; which you can try to run using the latest tag: &lt;code&gt;docker run --rm --privileged docker/binfmt:66f9012c56a8316f9244ffd7622d7c21c1f6f28d&lt;/code&gt; (another example of a similar project is &lt;a href=&quot;https://github.com/multiarch/qemu-user-static&quot;&gt;multiarch/qemu-user-static&lt;/a&gt;). If, for some reason, this does not work you should know enough by now to proceed with the registration manually.&lt;/p&gt; &lt;h2&gt;Creating container base images&lt;/h2&gt; &lt;p&gt;We have gone through creating chroot jails and transparently executing cross-architecture binaries with QEMU. A base image for a container is based pretty much on what we have just learned. To create a container base image we will create a jail with a foreign root filesystem and we will use QEMU to execute binaries inside the jail. Once all is working, we import it into docker.&lt;/p&gt; &lt;p&gt;To help us create a base system, we will use &lt;code&gt;debootstrap&lt;/code&gt; in two stages. We split this into two stages so we can setup QEMU in between.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;mkdir&lt;/span&gt; rootfs&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;debootstrap&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--foreign&lt;/span&gt; --no-check-gpg &lt;span class=&quot;token parameter variable&quot;&gt;--arch&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;arm buster ./rootfs http://httpredir.debian.org/debian/&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-v&lt;/span&gt; /usr/bin/qemu-arm-static ./rootfs/usr/bin/&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; ./rootfs ./debootstrap/debootstrap --second-stage &lt;span class=&quot;token parameter variable&quot;&gt;--verbose&lt;/span&gt;&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;mount&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-t&lt;/span&gt; devpts devpts ./rootfs/dev/pts&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;mount&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-t&lt;/span&gt; proc proc ./rootfs/proc&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;mount&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-t&lt;/span&gt; sysfs sysfs ./rootfs/sys&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;At this point our system is a debian base system with root at &lt;code&gt;./rootfs&lt;/code&gt;. Note that the &lt;code&gt;qemu&lt;/code&gt; you need to copy into &lt;code&gt;./rootfs/usr/bin&lt;/code&gt; needs to be static in order to avoid dynamic loading issues inside the jail when it is invoked.&lt;/p&gt; &lt;p&gt;Another important aspect to consider is that depending on your &lt;code&gt;binfmt&lt;/code&gt; setup, you need to put the binary in the proper place inside the jail. For the above to work, your &lt;code&gt;binfmt&lt;/code&gt; interpreter registration has to point to an interpreter at &lt;code&gt;/usr/bin/qemu-arm-static&lt;/code&gt;, which is the absolute path as seen from inside the jail. Now we can install all dependencies in the system at will. All commands will be using &lt;code&gt;qemu&lt;/code&gt; transparently to execute if &lt;code&gt;binfmt&lt;/code&gt; setup worked correctly. Remember that in the case of chroot jails (and also of containers), the kernel in use is the kernel of your host. Therefore that is the only kernel that needs to be set up with &lt;code&gt;binfmt&lt;/code&gt;. You set it up outside your chroot jail and when the kernel needs to execute a foreign executable, it will look at the current &lt;code&gt;binfmt&lt;/code&gt; setup for the interpreter. However, the kernel cannot access a filesystem outside the jail, so that interpreter needs to exist inside the it.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; ./rootfs &lt;span class=&quot;token function&quot;&gt;apt-get&lt;/span&gt; update&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; ./rootfs &lt;span class=&quot;token function&quot;&gt;apt-get&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-y&lt;/span&gt; upgrade&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; ./rootfs &lt;span class=&quot;token function&quot;&gt;apt-get&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-y&lt;/span&gt; g++ cmake libicu-dev &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; ruby-highline ruby-json python&lt;br&gt;&lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; ./rootfs &lt;span class=&quot;token function&quot;&gt;apt-get&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-y&lt;/span&gt; autoremove&lt;br&gt;&lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; ./rootfs &lt;span class=&quot;token function&quot;&gt;apt-get&lt;/span&gt; clean&lt;br&gt;&lt;span class=&quot;token function&quot;&gt;chroot&lt;/span&gt; ./rootfs &lt;span class=&quot;token function&quot;&gt;find&lt;/span&gt; /var/lib/apt/lists &lt;span class=&quot;token parameter variable&quot;&gt;-type&lt;/span&gt; f &lt;span class=&quot;token parameter variable&quot;&gt;-delete&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;These are the steps to install the dependencies to build and test JSC. Let&#39;s unmount the filesystems in order to create the docker base image.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token function&quot;&gt;umount&lt;/span&gt; ./rootfs/dev/pts&lt;br&gt;&lt;span class=&quot;token function&quot;&gt;umount&lt;/span&gt; ./rootfs/proc&lt;br&gt;&lt;span class=&quot;token function&quot;&gt;umount&lt;/span&gt; ./rootfs/sys&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;Let&#39;s &lt;code&gt;tar&lt;/code&gt; our jail and import it into a docker image.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;tar&lt;/span&gt; --numeric-owner &lt;span class=&quot;token parameter variable&quot;&gt;-cvf&lt;/span&gt; buster-arm.tar &lt;span class=&quot;token parameter variable&quot;&gt;-C&lt;/span&gt; ./rootfs &lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;import&lt;/span&gt; buster-arm.tar jsc-base:arm-raw&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;The image &lt;code&gt;jsc-base:arm-raw&lt;/code&gt; now contains our raw system. To be able to add metadata or build on top of this image before releasing we can build a docker image that extends the raw image version.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;EOF&lt;span class=&quot;token bash punctuation&quot;&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; jsc32-base.Dockerfile&lt;/span&gt;&lt;br&gt;FROM jsc32-base:arm-raw&lt;br&gt;&lt;br&gt;LABEL description=&quot;Minimal Debian image to reproduce JSC dev&quot;&lt;br&gt;LABEL maintainer=&quot;Paulo Matos &amp;lt;pmatos@igalia.com&gt;&quot;&lt;br&gt; &lt;br&gt;CMD [&quot;/bin/bash&quot;]&lt;br&gt;EOF&lt;/span&gt;&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; build &lt;span class=&quot;token parameter variable&quot;&gt;-t&lt;/span&gt; pmatos/jsc32-base:arm &lt;span class=&quot;token parameter variable&quot;&gt;-f&lt;/span&gt; jsc32-base.Dockerfile&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; push pmatos/jsc32-base:arm&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;Once we have pushed the image into the repository, we can run it from anywhere as long as &lt;code&gt;binfmt&lt;/code&gt; is setup properly.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;docker&lt;/span&gt; run pmatos/jsc32-base:arm &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; /bin/bash&lt;br&gt;/bin/bash: ELF &lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;-bit LSB pie executable, ARM, EABI5 version &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SYSV&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;, dynamically linked, &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;&lt;br&gt;interpreter /lib/ld-linux-armhf.so.3, &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; GNU/Linux &lt;span class=&quot;token number&quot;&gt;3.2&lt;/span&gt;.0, &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;&lt;br&gt;BuildID&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;sha1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;40e50d160a6c70d1a4e961200202cf853b4a2145, stripped&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;Or to get an interactive shell inside the container, use &lt;code&gt;-it&lt;/code&gt;: &lt;code&gt;docker run -it pmatos/jsc32-base:arm /bin/bash&lt;/code&gt;.&lt;/p&gt; &lt;h2&gt;Going rootless with podman&lt;/h2&gt; &lt;p&gt;While &lt;a href=&quot;https://www.docker.com&quot;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; is a product of Docker Inc with various components and pricing tiers, &lt;a href=&quot;https://podman.io&quot;&gt;&lt;code&gt;podman&lt;/code&gt;&lt;/a&gt; is a free and open source daemonless engine for developing, managing, and running containers on Linux. One of the main internal differences between &lt;code&gt;docker&lt;/code&gt; and &lt;code&gt;podman&lt;/code&gt; is that &lt;code&gt;podman&lt;/code&gt; uses &lt;a href=&quot;https://en.wikipedia.org/wiki/Cgroups&quot;&gt;cgroups&lt;/a&gt; v2, which &lt;code&gt;docker&lt;/code&gt; doesn&#39;t yet support. Since Fedora 31 ships with cgroups v2, for many users &lt;code&gt;podman&lt;/code&gt; is the only container engine available. Fortunately, &lt;code&gt;podman&lt;/code&gt; is largely &lt;code&gt;docker&lt;/code&gt; compatible meaning that you can &lt;code&gt;alias docker=podman&lt;/code&gt; without any issues.&lt;/p&gt; &lt;p&gt;So you can do something like this.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;podman&lt;/span&gt; run pmatos/jsc32-base:arm &lt;span class=&quot;token function&quot;&gt;file&lt;/span&gt; /bin/bash&lt;br&gt;/bin/bash: ELF &lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;-bit LSB pie executable, ARM, EABI5 version &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SYSV&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;, dynamically linked, &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;&lt;br&gt;interpreter /lib/ld-linux-armhf.so.3, &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; GNU/Linux &lt;span class=&quot;token number&quot;&gt;3.2&lt;/span&gt;.0, &lt;span class=&quot;token punctuation&quot;&gt;&#92;&lt;/span&gt;&lt;br&gt;BuildID&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;sha1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;40e50d160a6c70d1a4e961200202cf853b4a2145, stripped&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;As long your &lt;code&gt;binfmt&lt;/code&gt; is properly setup, it will run as well as it did with docker.&lt;/p&gt; &lt;h2&gt;Application to JSC&lt;/h2&gt; &lt;p&gt;The initial code developed for reproducible JSC32 builds can be found in the &lt;a href=&quot;https://github.com/pmatos/WebKit-misc/&quot;&gt;WebKit-misc&lt;/a&gt; repository and was initially pushed under commit &lt;a href=&quot;https://github.com/pmatos/WebKit-misc/commit/94bf25ebe888ae1824113eeb269fe0c0fcb5f3d4&quot;&gt;94bf25e&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;The main script is in &lt;a href=&quot;https://github.com/pmatos/WebKit-misc/blob/94bf25ebe888ae1824113eeb269fe0c0fcb5f3d4/containers/reprojsc.sh&quot;&gt;&lt;code&gt;containers/reprojsc.sh&lt;/code&gt;&lt;/a&gt; and follows the plan laid out in this blog post.&lt;/p&gt; &lt;ul&gt; &lt;li&gt;An image is created using &lt;a href=&quot;https://github.com/pmatos/WebKit-misc/blob/94bf25ebe888ae1824113eeb269fe0c0fcb5f3d4/containers/jsc32-base/build-image.sh&quot;&gt;&lt;code&gt;containers/jsc32-base/build-image.sh&lt;/code&gt;&lt;/a&gt; and pushed into docker hub &lt;a href=&quot;https://hub.docker.com/r/pmatos/jsc32-base&quot;&gt;pmatos/jsc32-base&lt;/a&gt;. This only needs to be done when the image is changed.&lt;/li&gt; &lt;li&gt;The &lt;a href=&quot;https://github.com/pmatos/WebKit-misc/blob/94bf25ebe888ae1824113eeb269fe0c0fcb5f3d4/containers/reprojsc.sh&quot;&gt;&lt;code&gt;containers/reprojsc.sh&lt;/code&gt;&lt;/a&gt; script is run each time one wants to trigger a build and/or test of JSC. This sets up QEMU for the desired architecture, starts the image and issues the necessary commands for the actions laid out in the command line.&lt;/li&gt; &lt;/ul&gt; &lt;p&gt;To run it yourself, checkout &lt;a href=&quot;https://github.com/pmatos/WebKit-misc/&quot;&gt;WebKit-misc&lt;/a&gt; and &lt;a href=&quot;https://webkit.org&quot;&gt;WebKit&lt;/a&gt;, and run &lt;code&gt;reprojsc.sh&lt;/code&gt;.&lt;/p&gt; &lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; clone &lt;span class=&quot;token parameter variable&quot;&gt;--depth&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; git://git.webkit.org/WebKit.git&lt;br&gt;$ &lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;WEBKIT_PATH&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token environment constant&quot;&gt;$PWD&lt;/span&gt;/WebKit&lt;br&gt;$ &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; clone &lt;span class=&quot;token parameter variable&quot;&gt;--depth&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; git@github.com:pmatos/WebKit-misc.git&lt;br&gt;$ &lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; WebKit-misc/containers&lt;br&gt;$ ./reprojsc.sh &lt;span class=&quot;token parameter variable&quot;&gt;-a&lt;/span&gt; arm &lt;span class=&quot;token parameter variable&quot;&gt;-b&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-t&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-i&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$WEBKIT_PATH&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt; &lt;p&gt;This will build, test and send you into an interactive session so you can debug some possibly failed tests. Inside the container, you&#39;ll be in an ARM Cortex-A7 (32bits) environment. The other available architecture at the moment is MIPS which can be chosen with &lt;code&gt;-a mips&lt;/code&gt;.&lt;/p&gt; &lt;p&gt;If you have any issues or requests please open an issue in &lt;a href=&quot;https://github.com/pmatos/WebKit-misc/issues&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt; &lt;h2&gt;What&#39;s missing?&lt;/h2&gt; &lt;p&gt;There are many things that deserved discussion but I won&#39;t elaborate further. One of them is the difference between the container execution engine and the image builder. When using docker it&#39;s easy to think that they are the same but it is not the case. For example, docker has a new image builder, called &lt;a href=&quot;https://docs.docker.com/buildx/working-with-buildx/&quot;&gt;&lt;code&gt;buildx&lt;/code&gt;&lt;/a&gt; whichhas in-built support for the creation of multi-architecture images. On the other hand, &lt;code&gt;podman&lt;/code&gt; is a container execution engine but an image creator is, for example, &lt;a href=&quot;https://buildah.io/&quot;&gt;&lt;code&gt;buildah&lt;/code&gt;&lt;/a&gt;, which doesn&#39;t have multi-architecture image support &lt;a href=&quot;https://github.com/containers/buildah/issues/1590&quot;&gt;yet&lt;/a&gt;. Don&#39;t worry if you are confused - things are moving fast in this area and it&#39;s easy to lose track of all the tools out there.&lt;/p&gt; &lt;p&gt;With the ability to transparently emulate other architectures QEMU user mode will see more usage patterns. Bugs in QEMU can look like application bugs and debugging is not straightforward, so bear in this in mind when using this technology.&lt;/p&gt; &lt;h2&gt;Acknowledgments&lt;/h2&gt; &lt;p&gt;Thanks to my fellow Igalians Angelos Oikonomopoulos and Philip Chimento for providing suggestions and corrections for this blog post.&lt;/p&gt; &nbsp;of&nbsp;Reading&nbsp;Time</small><h1>Cross-Arch Reproducibility using Containers</h1><h2>Introduction</h2><p>Part of my work for Igalia is on the 32bit support on MIPS (little endian) and ARM for JSC (JavaScriptCore - the JavaScript compiler in WebKit) and one of the problems we face is that of reproducibility of failures.</p><p>We have boards to test these, namely Raspberry Pi 3 Model B+ boards, running a 32bits ARM kernel and Imagination CI20 boards running a mipsel kernel - all built with buildroot which provides images for these boards out-of-the-box. However, we don't work on these - most of us have higher performance x86_64 machines and whenever a failure occurs upstream it's generally time consuming to reproduce.</p><p>I have therefore set out to create an environment where we can easily reproduce cross-architectural failures on JSC. I had worked on similar issues for <a href="https://racket-lang.org">Racket</a>, when building the cross-architectural Racket chroot environment on GitLab CI.</p><h2>Starting with chroot</h2><p>Let's start the discussion by talking about <code>chroot</code>. In any linux system you'll find a <code>chroot</code> binary.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">which</span> <span class="token function">chroot</span><br>/usr/sbin/chroot<br>$ <span class="token function">chroot</span> <span class="token parameter variable">--help</span><br>Usage: <span class="token function">chroot</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span> NEWROOT <span class="token punctuation">[</span>COMMAND <span class="token punctuation">[</span>ARG<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span><br>  or:  <span class="token function">chroot</span> OPTION<br>Run COMMAND with root directory <span class="token builtin class-name">set</span> to NEWROOT.<br><br>  <span class="token parameter variable">--groups</span><span class="token operator">=</span>G_LIST        specify supplementary <span class="token function">groups</span> as g1,g2,<span class="token punctuation">..</span>,gN<br>  <span class="token parameter variable">--userspec</span><span class="token operator">=</span><span class="token environment constant">USER</span>:GROUP  specify user and group <span class="token punctuation">(</span>ID or name<span class="token punctuation">)</span> to use<br>  --skip-chdir           <span class="token keyword">do</span> not change working directory to <span class="token string">'/'</span><br>      <span class="token parameter variable">--help</span>     display this <span class="token builtin class-name">help</span> and <span class="token builtin class-name">exit</span><br>      <span class="token parameter variable">--version</span>  output version information and <span class="token builtin class-name">exit</span><br><br>If no <span class="token builtin class-name">command</span> is given, run <span class="token string">'"$SHELL" -i'</span> <span class="token punctuation">(</span>default: <span class="token string">'/bin/sh -i'</span><span class="token punctuation">)</span>.<br><br>GNU coreutils online help: <span class="token operator">&lt;</span>https://www.gnu.org/software/coreutils/<span class="token operator">></span><br>Full documentation at: <span class="token operator">&lt;</span>https://www.gnu.org/software/coreutils/chroot<span class="token operator">></span><br>or available locally via: info <span class="token string">'(coreutils) chroot invocation'</span></code></pre><p>However, at a slightly lower level, <a href="http://man7.org/linux/man-pages/man2/chroot.2.html"><code>chroot</code></a> is a system call.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">man</span> <span class="token parameter variable">-s2</span> <span class="token function">chroot</span><br>CHROOT<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><br><br>NAME<br>       <span class="token function">chroot</span> - change root directory<br><br>SYNOPSIS<br>       <span class="token comment">#include &lt;unistd.h></span><br><br>       int chroot<span class="token punctuation">(</span>const char *path<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>   Feature Test Macro Requirements <span class="token keyword">for</span> glibc <span class="token punctuation">(</span>see feature_test_macros<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">))</span>:<br><span class="token punctuation">..</span>.</code></pre><p>As mentioned in the man page, it changes the root of the file system for a process to the path passed as argument. This new environment created for the process is known as a chroot jail, to which we will refer simply as a <em>jail</em>.</p><p>The jail allows us to trap a process inside a filesystem, i.e. the process cannot access anything outside the filesystem it is in. So, if it tried to access the root of the filesystem, inside the jail it will only see the root of the new file system which is the path we passed on to <code>chroot</code>.</p><p>As an example throughout the post I will be using the factorial function. Whenever I refer to <code>factorial.c</code>, I refer to a file that you might have to create as needed and consists of the following C source code.</p><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;inttypes.h></span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><br><br><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token class-name">uint64_t</span> result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token class-name">uint32_t</span> arg<span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><br><br>  arg <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">while</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> result <span class="token operator">*=</span> arg<span class="token operator">--</span><span class="token punctuation">;</span><br><br>  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Result: %"</span> PRIu64 <span class="token string">"\n"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Let's compile it and run an example.</p><pre class="language-shell"><code class="language-shell">$ gcc <span class="token parameter variable">-Wall</span> <span class="token parameter variable">-Wextra</span> <span class="token parameter variable">-o</span> factorial factorial.c<br>$ ./factorial <span class="token number">20</span><br>Result: <span class="token number">2432902008176640000</span></code></pre><p>Let's create a jail for this binary using <code>chroot</code> and run it.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">mkdir</span> jail<br>$ <span class="token function">cp</span> factorial jail/<br>$ <span class="token function">chroot</span> jail/ /factorial<br>chroot: cannot change root directory to <span class="token string">'jail/'</span><span class="token builtin class-name">:</span> Operation not permitted</code></pre><p>First lesson here: only <code>root</code> can <code>chroot</code>. For security reasons, a normal user cannot <code>chroot</code>. Being able to do so, would allow the user privilege escalation (<a href="https://web.archive.org/web/20160127150916/http://www.bpfh.net/simes/computing/chroot-break.html">further details</a> on breaking out of the chroot jail and privilege escalation).</p><p>So we <code>sudo</code>:</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">sudo</span> <span class="token function">chroot</span> jail/ /factorial<br>chroot: failed to run <span class="token builtin class-name">command</span> ‘/factorial’: No such <span class="token function">file</span> or directory</code></pre><p>Now this really starts to annoy you and you start wondering if the path to <code>factorial</code> is correct. It is correct, the path is relative to the jail root. Once the root becomes <code>jail/</code>, the <code>factorial</code> binary is in the root of the filesystem so <code>/factorial</code> is correct. The problem is subtle but will teach you an important lesson: dependencies. This is, after all, a dynamically linked executable 💡.</p><pre class="language-shell"><code class="language-shell">$ ldd factorial<br>        linux-vdso.so.1 <span class="token punctuation">(</span>0x00007ffe1f7f9000<span class="token punctuation">)</span><br>        libc.so.6 <span class="token operator">=</span><span class="token operator">></span> /lib/x86_64-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0x00007f65bf62e000<span class="token punctuation">)</span><br>        /lib64/ld-linux-x86-64.so.2 <span class="token punctuation">(</span>0x00007f65bf844000<span class="token punctuation">)</span></code></pre><p>Those files exist in your file system, but not in the jail, so you get an error (although a pretty terrible error message at that). Let's try a static executable instead.</p><pre class="language-shell"><code class="language-shell">$ gcc <span class="token parameter variable">-Wall</span> <span class="token parameter variable">-Wextra</span> <span class="token parameter variable">-static</span> <span class="token parameter variable">-o</span> factorial factorial.c<br>$ ldd factorial<br>        not a dynamic executable<br>$ <span class="token function">sudo</span> <span class="token function">chroot</span> jail/ /factorial <span class="token number">20</span><br>Result: <span class="token number">2432902008176640000</span></code></pre><p>This is exactly what we wanted from the beginning - to show that the binary is now jailed in this root and cannot escape without explicitly trying to, something no benign binary is likely to do (see my comment above on escaping jail).</p><p>In chroot jails, the filesystem root changes but it's still running on the same kernel. This allows us to create a new userspace inside this jail, separate from the host's, and possibly based on a different linux distribution. For reproducibility, you can potentially tarball this jail and send it to someone else, who could themselves <code>chroot</code> into it and reproduce a specific problem.</p><h2>QEMU and binfmt</h2><p>I will now introduce two other essential components to achieve our goal of cross architecture reproducibility: QEMU and binfmt.</p><p>Up until now our jail has contained binaries compiled for our host architecture (in my case x86_64), however this need not be the case. <a href="https://www.qemu.org">QEMU</a> is an open-source hardware emulator and virtualizer. It implements two execution modes: system mode, and user mode;</p><p>In system mode, QEMU works like <a href="https://www.virtualbox.org">VirtualBox</a> it emulates a whole system - from the applications, interrupts, and kernel, all the way to the hardware devices. The one I am interested in is user mode. In user mode, QEMU emulates a single binary leaving the rest of the system untouched.</p><p>To demo how it works, lets use a cross-toolchain to compile a program to be run on a different architecture. Given I am on a <code>x86_64</code>, I will use an <code>armhf</code> toolchain. You can either download one provided from your distro or compile one with <a href="https://crosstool-ng.github.io/">crosstool-ng</a>.</p><p>For the sake of reproducibility, lets compile a pre-configured one with <code>crosstool-ng</code>. Download it and install it in <code>$PATH</code> - I used version 1.24.0. Then build the cross toolchain for <code>armv7-rpi2-linux-gnueabihf</code>.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">mkdir</span> build<br>$ <span class="token builtin class-name">cd</span> build<br>build/ $ ct-ng armv7-rpi2-linux-gnueabihf<br>build/ $ ct-ng build</code></pre><p>Let's once again compile the <code>factorial.c</code> example, but this time with our new toolchain. This toolchain will be in <code>$HOME/x-tools/armv7-rpi2-linux-gnueabihf</code> by default.</p><pre class="language-shell"><code class="language-shell">$ <span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$HOME</span>/x-tools/armv7-rpi2-linux-gnueabihf/bin:<span class="token environment constant">$PATH</span><br>$ armv7-rpi2-linux-gnueabihf-gcc <span class="token parameter variable">-static</span> <span class="token parameter variable">-o</span> factorial factorial.c<br>$ ./factorial<br>zsh: <span class="token builtin class-name">exec</span> <span class="token function">format</span> error: ./factorial<br>$ <span class="token function">file</span> factorial<br>factorial: ELF <span class="token number">32</span>-bit LSB executable, ARM, EABI5 version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, <span class="token punctuation">\</span><br>dynamically linked, interpreter /lib/ld-linux-armhf.so.3, <span class="token keyword">for</span> GNU/Linux <span class="token punctuation">\</span><br><span class="token number">4.19</span>.21, with debug_info, not stripped</code></pre><p>We were expecting this error, right? After all, we cannot just execute an arm binary in a x86_64 system. However, we can if we use QEMU in user mode which is what I want to show:</p><pre class="language-shell"><code class="language-shell">$ qemu-arm ./factorial <span class="token number">20</span> <br>Result: <span class="token number">2432902008176640000</span></code></pre><p>Now we have it working - however, there's a last tool we need to discuss and that's <code>binfmt</code>. <code>binfmt_misc</code> is a linux kernel capability that allows arbitrary executable file formats to be recognized and passed on to an interpreter. This means that we can transparently recognize arm (or any other architecture) executables and request them to be passed to QEMU transparently when we try to execute them.</p><p>Before proceeding, if you wish to follow the examples, verify that your kernel has <code>binfmt</code> enabled.</p><pre class="language-shell"><code class="language-shell">$ zcat /proc/config.gz<span class="token operator">|</span> <span class="token function">grep</span> BINFMT<br><span class="token assign-left variable">CONFIG_BINFMT_ELF</span><span class="token operator">=</span>y<br><span class="token assign-left variable">CONFIG_COMPAT_BINFMT_ELF</span><span class="token operator">=</span>y<br><span class="token assign-left variable">CONFIG_BINFMT_SCRIPT</span><span class="token operator">=</span>y<br><span class="token assign-left variable">CONFIG_BINFMT_MISC</span><span class="token operator">=</span>y</code></pre><p>If you don't have <code>/proc/config.gz</code> try instead <code>grep BINFMT /boot/config-$(uname -r)</code>.</p><p>Let's go back to our factorial on arm example, but this time install a <code>binfmt</code> record to call <code>qemu-arm</code> on the executable whenever we try to execute it directly. A <code>binfmt</code> record looks like <code>:name:type:offset:magic:mask:interpreter:flags</code> and needs to be installed by echoing the correct string to <code>/proc/sys/fs/binfmt_misc/register</code>. For details on this consult the <a href="https://www.kernel.org/doc/html/latest/admin-guide/binfmt-misc.html">kernel documentation</a>. For <code>armv7</code> we can register our interpreter and run our binary transparently like this:</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">sudo</span> <span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">'echo ":qemu-arm:M:0:\\x7f\\x45\\x4c\\x46\\x01\\x01\\x01\\x00\\x00\\x00\\x00\\x00\\x00\<br>\\x00\\x00\\x00\\x02\\x00\\x28\\x00:\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\xff\\xff\<br>\\xff\\xff\\xff\\xfe\\xff\\xff\\xff:/home/pmatos/installs/bin/qemu-arm:OCF" > \<br>/proc/sys/fs/binfmt_misc/register'</span><br>$ ./factorial <span class="token number">20</span><br>Result: <span class="token number">2432902008176640000</span></code></pre><p>The write to <code>/proc/sys/fs/binfmt_misc/register</code> may fail if you already have a record for <code>qemu-arm</code> setup. To remove the record run <code>echo -1 &gt; /proc/sys/fs/binfmt_misc/qemu-arm</code>. Note that the file, as shown above is an ARM binary and yet we transparently run it through QEMU thanks to the <code>binfmt</code> magic we have initially set up.</p><p>I should note, that while interesting to understand how this works behind the scenes, several people have created images to do the binfmt registration for you. One of those projects is <a href="https://hub.docker.com/r/docker/binfmt/tags">docker/binfmt</a> which you can try to run using the latest tag: <code>docker run --rm --privileged docker/binfmt:66f9012c56a8316f9244ffd7622d7c21c1f6f28d</code> (another example of a similar project is <a href="https://github.com/multiarch/qemu-user-static">multiarch/qemu-user-static</a>). If, for some reason, this does not work you should know enough by now to proceed with the registration manually.</p><h2>Creating container base images</h2><p>We have gone through creating chroot jails and transparently executing cross-architecture binaries with QEMU. A base image for a container is based pretty much on what we have just learned. To create a container base image we will create a jail with a foreign root filesystem and we will use QEMU to execute binaries inside the jail. Once all is working, we import it into docker.</p><p>To help us create a base system, we will use <code>debootstrap</code> in two stages. We split this into two stages so we can setup QEMU in between.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">mkdir</span> rootfs<br>$ <span class="token function">debootstrap</span> <span class="token parameter variable">--foreign</span> --no-check-gpg <span class="token parameter variable">--arch</span><span class="token operator">=</span>arm buster ./rootfs http://httpredir.debian.org/debian/<br>$ <span class="token function">cp</span> <span class="token parameter variable">-v</span> /usr/bin/qemu-arm-static ./rootfs/usr/bin/<br>$ <span class="token function">chroot</span> ./rootfs ./debootstrap/debootstrap --second-stage <span class="token parameter variable">--verbose</span><br>$ <span class="token function">mount</span> <span class="token parameter variable">-t</span> devpts devpts ./rootfs/dev/pts<br>$ <span class="token function">mount</span> <span class="token parameter variable">-t</span> proc proc ./rootfs/proc<br>$ <span class="token function">mount</span> <span class="token parameter variable">-t</span> sysfs sysfs ./rootfs/sys</code></pre><p>At this point our system is a debian base system with root at <code>./rootfs</code>. Note that the <code>qemu</code> you need to copy into <code>./rootfs/usr/bin</code> needs to be static in order to avoid dynamic loading issues inside the jail when it is invoked.</p><p>Another important aspect to consider is that depending on your <code>binfmt</code> setup, you need to put the binary in the proper place inside the jail. For the above to work, your <code>binfmt</code> interpreter registration has to point to an interpreter at <code>/usr/bin/qemu-arm-static</code>, which is the absolute path as seen from inside the jail. Now we can install all dependencies in the system at will. All commands will be using <code>qemu</code> transparently to execute if <code>binfmt</code> setup worked correctly. Remember that in the case of chroot jails (and also of containers), the kernel in use is the kernel of your host. Therefore that is the only kernel that needs to be set up with <code>binfmt</code>. You set it up outside your chroot jail and when the kernel needs to execute a foreign executable, it will look at the current <code>binfmt</code> setup for the interpreter. However, the kernel cannot access a filesystem outside the jail, so that interpreter needs to exist inside the it.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">chroot</span> ./rootfs <span class="token function">apt-get</span> update<br>$ <span class="token function">chroot</span> ./rootfs <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> upgrade<br>$ <span class="token function">chroot</span> ./rootfs <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> g++ cmake libicu-dev <span class="token function">git</span> ruby-highline ruby-json python<br><span class="token function">chroot</span> ./rootfs <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> autoremove<br><span class="token function">chroot</span> ./rootfs <span class="token function">apt-get</span> clean<br><span class="token function">chroot</span> ./rootfs <span class="token function">find</span> /var/lib/apt/lists <span class="token parameter variable">-type</span> f <span class="token parameter variable">-delete</span></code></pre><p>These are the steps to install the dependencies to build and test JSC. Let's unmount the filesystems in order to create the docker base image.</p><pre class="language-shell"><code class="language-shell"><span class="token function">umount</span> ./rootfs/dev/pts<br><span class="token function">umount</span> ./rootfs/proc<br><span class="token function">umount</span> ./rootfs/sys</code></pre><p>Let's <code>tar</code> our jail and import it into a docker image.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">tar</span> --numeric-owner <span class="token parameter variable">-cvf</span> buster-arm.tar <span class="token parameter variable">-C</span> ./rootfs <span class="token builtin class-name">.</span><br>$ <span class="token function">docker</span> <span class="token function">import</span> buster-arm.tar jsc-base:arm-raw</code></pre><p>The image <code>jsc-base:arm-raw</code> now contains our raw system. To be able to add metadata or build on top of this image before releasing we can build a docker image that extends the raw image version.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> jsc32-base.Dockerfile</span><br>FROM jsc32-base:arm-raw<br><br>LABEL description="Minimal Debian image to reproduce JSC dev"<br>LABEL maintainer="Paulo Matos &lt;pmatos@igalia.com>"<br> <br>CMD ["/bin/bash"]<br>EOF</span><br>$ <span class="token function">docker</span> build <span class="token parameter variable">-t</span> pmatos/jsc32-base:arm <span class="token parameter variable">-f</span> jsc32-base.Dockerfile<br>$ <span class="token function">docker</span> push pmatos/jsc32-base:arm</code></pre><p>Once we have pushed the image into the repository, we can run it from anywhere as long as <code>binfmt</code> is setup properly.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">docker</span> run pmatos/jsc32-base:arm <span class="token function">file</span> /bin/bash<br>/bin/bash: ELF <span class="token number">32</span>-bit LSB pie executable, ARM, EABI5 version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, <span class="token punctuation">\</span><br>interpreter /lib/ld-linux-armhf.so.3, <span class="token keyword">for</span> GNU/Linux <span class="token number">3.2</span>.0, <span class="token punctuation">\</span><br>BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>40e50d160a6c70d1a4e961200202cf853b4a2145, stripped</code></pre><p>Or to get an interactive shell inside the container, use <code>-it</code>: <code>docker run -it pmatos/jsc32-base:arm /bin/bash</code>.</p><h2>Going rootless with podman</h2><p>While <a href="https://www.docker.com"><code>docker</code></a> is a product of Docker Inc with various components and pricing tiers, <a href="https://podman.io"><code>podman</code></a> is a free and open source daemonless engine for developing, managing, and running containers on Linux. One of the main internal differences between <code>docker</code> and <code>podman</code> is that <code>podman</code> uses <a href="https://en.wikipedia.org/wiki/Cgroups">cgroups</a> v2, which <code>docker</code> doesn't yet support. Since Fedora 31 ships with cgroups v2, for many users <code>podman</code> is the only container engine available. Fortunately, <code>podman</code> is largely <code>docker</code> compatible meaning that you can <code>alias docker=podman</code> without any issues.</p><p>So you can do something like this.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">podman</span> run pmatos/jsc32-base:arm <span class="token function">file</span> /bin/bash<br>/bin/bash: ELF <span class="token number">32</span>-bit LSB pie executable, ARM, EABI5 version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, <span class="token punctuation">\</span><br>interpreter /lib/ld-linux-armhf.so.3, <span class="token keyword">for</span> GNU/Linux <span class="token number">3.2</span>.0, <span class="token punctuation">\</span><br>BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>40e50d160a6c70d1a4e961200202cf853b4a2145, stripped</code></pre><p>As long your <code>binfmt</code> is properly setup, it will run as well as it did with docker.</p><h2>Application to JSC</h2><p>The initial code developed for reproducible JSC32 builds can be found in the <a href="https://github.com/pmatos/WebKit-misc/">WebKit-misc</a> repository and was initially pushed under commit <a href="https://github.com/pmatos/WebKit-misc/commit/94bf25ebe888ae1824113eeb269fe0c0fcb5f3d4">94bf25e</a>.</p><p>The main script is in <a href="https://github.com/pmatos/WebKit-misc/blob/94bf25ebe888ae1824113eeb269fe0c0fcb5f3d4/containers/reprojsc.sh"><code>containers/reprojsc.sh</code></a> and follows the plan laid out in this blog post.</p><ul><li>An image is created using <a href="https://github.com/pmatos/WebKit-misc/blob/94bf25ebe888ae1824113eeb269fe0c0fcb5f3d4/containers/jsc32-base/build-image.sh"><code>containers/jsc32-base/build-image.sh</code></a> and pushed into docker hub <a href="https://hub.docker.com/r/pmatos/jsc32-base">pmatos/jsc32-base</a>. This only needs to be done when the image is changed.</li><li>The <a href="https://github.com/pmatos/WebKit-misc/blob/94bf25ebe888ae1824113eeb269fe0c0fcb5f3d4/containers/reprojsc.sh"><code>containers/reprojsc.sh</code></a> script is run each time one wants to trigger a build and/or test of JSC. This sets up QEMU for the desired architecture, starts the image and issues the necessary commands for the actions laid out in the command line.</li></ul><p>To run it yourself, checkout <a href="https://github.com/pmatos/WebKit-misc/">WebKit-misc</a> and <a href="https://webkit.org">WebKit</a>, and run <code>reprojsc.sh</code>.</p><pre class="language-shell"><code class="language-shell">$ <span class="token function">git</span> clone <span class="token parameter variable">--depth</span><span class="token operator">=</span><span class="token number">1</span> git://git.webkit.org/WebKit.git<br>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">WEBKIT_PATH</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/WebKit<br>$ <span class="token function">git</span> clone <span class="token parameter variable">--depth</span><span class="token operator">=</span><span class="token number">1</span> git@github.com:pmatos/WebKit-misc.git<br>$ <span class="token builtin class-name">cd</span> WebKit-misc/containers<br>$ ./reprojsc.sh <span class="token parameter variable">-a</span> arm <span class="token parameter variable">-b</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-i</span> <span class="token variable">$WEBKIT_PATH</span></code></pre><p>This will build, test and send you into an interactive session so you can debug some possibly failed tests. Inside the container, you'll be in an ARM Cortex-A7 (32bits) environment. The other available architecture at the moment is MIPS which can be chosen with <code>-a mips</code>.</p><p>If you have any issues or requests please open an issue in <a href="https://github.com/pmatos/WebKit-misc/issues">GitHub</a>.</p><h2>What's missing?</h2><p>There are many things that deserved discussion but I won't elaborate further. One of them is the difference between the container execution engine and the image builder. When using docker it's easy to think that they are the same but it is not the case. For example, docker has a new image builder, called <a href="https://docs.docker.com/buildx/working-with-buildx/"><code>buildx</code></a> whichhas in-built support for the creation of multi-architecture images. On the other hand, <code>podman</code> is a container execution engine but an image creator is, for example, <a href="https://buildah.io/"><code>buildah</code></a>, which doesn't have multi-architecture image support <a href="https://github.com/containers/buildah/issues/1590">yet</a>. Don't worry if you are confused - things are moving fast in this area and it's easy to lose track of all the tools out there.</p><p>With the ability to transparently emulate other architectures QEMU user mode will see more usage patterns. Bugs in QEMU can look like application bugs and debugging is not straightforward, so bear in this in mind when using this technology.</p><h2>Acknowledgments</h2><p>Thanks to my fellow Igalians Angelos Oikonomopoulos and Philip Chimento for providing suggestions and corrections for this blog post.</p></article><footer><div class="credit">&copy; 2024&nbsp;Paulo Matos</div><ul class="social"><li class="icon"><a target="_blank" rel="noopener noreferrer" title="Twitter account" href="https://twitter.com/pocmatos"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z"></path></svg></a></li><li class="icon"><a target="_blank" rel="noopener noreferrer" title="Linkedin account" href="https://www.linkedin.com/in/pmatos/"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path>}}<rect x="4" y="4" width="16" height="16" rx="2"></rect><line x1="8" y1="11" x2="8" y2="16"></line><line x1="8" y1="8" x2="8" y2="8.01"></line><line x1="12" y1="16" x2="12" y2="11"></line><path d="M16 16v-3a2 2 0 0 0 -4 0"></path></svg></a></li><li class="icon"><a target="_blank" rel="noopener noreferrer" title="Github account" href="https://github.com/pmatos"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path></svg></a></li></ul></footer></body></html>