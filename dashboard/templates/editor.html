{% extends "base.html" %}

{% block title %}Edit: {{ draft.title }}{% endblock %}

{% block content %}
<div class="editor-container">
    <div class="editor-header">
        <div class="editor-meta">
            <input type="text" id="title" value="{{ draft.title }}" placeholder="Title" class="input input-title" data-draft-id="{{ draft.id }}">
            <input type="text" id="description" value="{{ draft.description or '' }}" placeholder="Description (for meta)" class="input">
            <input type="text" id="tags" value="{{ draft.tags | join(', ') if draft.tags else '' }}" placeholder="Tags (comma-separated)" class="input">
        </div>
        <div class="editor-actions">
            <button id="save-btn" class="btn btn-secondary">Save</button>
            <button id="analyze-btn" class="btn btn-primary">Analyze</button>
            <button id="publish-btn" class="btn btn-success">Publish</button>
        </div>
    </div>

    <div class="editor-body">
        <div class="editor-left">
            <div class="editor-section">
                <label>Audience Notes (for AI context)</label>
                <textarea id="audience-notes" placeholder="Describe your target audience, tone, and any specific guidelines..." class="input textarea-small">{{ draft.audience_notes or '' }}</textarea>
            </div>

            <div class="editor-section editor-main">
                <label>Content (Markdown)</label>
                <div class="editor-toolbar">
                    <button type="button" id="toolbar-image" class="toolbar-btn" title="Insert Image">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <span>Image</span>
                    </button>
                    <button type="button" id="toolbar-video" class="toolbar-btn" title="Insert Video">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="23 7 16 12 23 17 23 7"></polygon>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg>
                        <span>Video</span>
                    </button>
                </div>
                <textarea id="content">{{ draft.content or '' }}</textarea>
            </div>
        </div>

        <div class="editor-right">
            <div class="analysis-panel">
                <h3>AI Analysis</h3>
                <div id="analysis-content">
                    {% if draft.ai_analysis %}
                        {% set analysis = draft.ai_analysis %}
                        {% for item in analysis %}
                        <div class="analysis-item">
                            <div class="analysis-header">
                                <span class="analysis-index">Paragraph {{ item.paragraph_index + 1 }}</span>
                                <span class="rating-badge rating-{{ item.overall_rating | replace('_', '-') }}">{{ item.overall_rating }}</span>
                            </div>
                            <p class="analysis-paragraph">{{ item.paragraph_text | truncate(150) }}</p>
                            <p class="analysis-summary"><strong>Summary:</strong> {{ item.summary }}</p>
                            <p class="analysis-flow"><strong>Flow:</strong> {{ item.flow_with_context }}</p>
                            {% if item.suggestions %}
                            <div class="suggestions">
                                <strong>Suggestions:</strong>
                                {% for sugg in item.suggestions %}
                                <div class="suggestion suggestion-{{ sugg.type }}">
                                    <span class="suggestion-type">{{ sugg.type }}</span>
                                    <p>{{ sugg.description }}</p>
                                    {% if sugg.example %}
                                    <pre class="suggestion-example">{{ sugg.example }}</pre>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <p class="empty-state">Click "Analyze" to get AI feedback on your writing.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="image-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <button type="button" class="modal-close" onclick="hideImageModal()">&times;</button>
        <h3>Insert Image</h3>
        <div class="modal-tabs">
            <button type="button" class="modal-tab active" data-tab="upload">Upload File</button>
            <button type="button" class="modal-tab" data-tab="url">External URL</button>
        </div>
        <div class="modal-tab-content" id="image-tab-upload">
            <div class="upload-zone" id="image-upload-zone">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p>Drag and drop an image here, or click to select</p>
                <input type="file" id="image-file-input" accept="image/*" style="display: none;">
            </div>
            <div id="image-upload-preview" class="upload-preview" style="display: none;">
                <img id="image-preview-img" src="" alt="Preview">
                <p id="image-preview-name"></p>
            </div>
        </div>
        <div class="modal-tab-content" id="image-tab-url" style="display: none;">
            <label class="modal-label">Image URL</label>
            <input type="text" id="image-url-input" class="input" placeholder="https://example.com/image.png">
            <div id="image-url-preview" class="upload-preview" style="display: none; margin-top: 1rem;">
                <img id="image-url-preview-img" src="" alt="Preview">
            </div>
        </div>
        <div class="modal-field">
            <label class="modal-label">Alt Text (optional)</label>
            <input type="text" id="image-alt-input" class="input" placeholder="Describe the image for accessibility">
        </div>
        <div class="modal-actions">
            <button type="button" onclick="hideImageModal()" class="btn btn-secondary">Cancel</button>
            <button type="button" id="insert-image-btn" class="btn btn-primary">Insert Image</button>
        </div>
        <div id="image-status" class="result-message"></div>
    </div>
</div>

<div id="video-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <button type="button" class="modal-close" onclick="hideVideoModal()">&times;</button>
        <h3>Insert Video</h3>
        <div class="modal-tabs">
            <button type="button" class="modal-tab active" data-tab="youtube">YouTube</button>
            <button type="button" class="modal-tab" data-tab="upload">Upload File</button>
        </div>
        <div class="modal-tab-content" id="video-tab-youtube">
            <label class="modal-label">YouTube URL</label>
            <input type="text" id="youtube-url-input" class="input" placeholder="https://www.youtube.com/watch?v=...">
            <div id="youtube-preview" class="video-preview" style="display: none; margin-top: 1rem;">
                <img id="youtube-thumbnail" src="" alt="Video thumbnail">
            </div>
        </div>
        <div class="modal-tab-content" id="video-tab-upload" style="display: none;">
            <div class="upload-zone" id="video-upload-zone">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p>Drag and drop a video here, or click to select</p>
                <p class="upload-hint">Supported: MP4, WebM (max 50MB)</p>
                <input type="file" id="video-file-input" accept="video/mp4,video/webm" style="display: none;">
            </div>
            <div id="video-upload-preview" class="upload-preview" style="display: none;">
                <video id="video-preview-element" controls style="max-width: 100%; max-height: 200px;"></video>
                <p id="video-preview-name"></p>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="hideVideoModal()" class="btn btn-secondary">Cancel</button>
            <button type="button" id="insert-video-btn" class="btn btn-primary">Insert Video</button>
        </div>
        <div id="video-status" class="result-message"></div>
    </div>
</div>

<div id="publish-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Publish Post</h3>
        <p>Are you sure you want to publish "<strong id="publish-title"></strong>"?</p>
        <p>This will:</p>
        <ul>
            <li>Create a markdown file in src/blog/</li>
            <li>Build the site</li>
            <li>Commit and push to git</li>
        </ul>
        <div class="modal-actions">
            <button onclick="hidePublishModal()" class="btn btn-secondary">Cancel</button>
            <button id="confirm-publish-btn" class="btn btn-success">Publish</button>
        </div>
        <div id="publish-status" class="result-message"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/editor.js"></script>
{% endblock %}
