{% extends "base.html" %}

{% block title %}Link Queue{% endblock %}

{% block content %}
<div class="container">
    <h1>Link Queue</h1>

    <div class="section">
        <h2>Add Link</h2>
        <form hx-post="/api/links/" hx-target="#link-tbody" hx-swap="afterbegin" hx-on::after-request="this.reset()" class="add-form">
            <input type="url" name="url" placeholder="https://..." required class="input">
            <input type="text" name="tags" placeholder="#tag1 #tag2" class="input">
            <button type="submit" class="btn btn-primary">Add to Queue</button>
        </form>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Queue</h2>
            <button id="process-btn" onclick="processNextLink()" class="btn btn-primary">
                Process Next Link
            </button>
        </div>
        <div id="progress-container" class="progress-container" style="display: none;">
            <div class="progress-header">
                <span id="progress-url" class="progress-url"></span>
                <span id="progress-status" class="progress-status"></span>
            </div>
            <div class="progress-log" id="progress-log"></div>
        </div>
        <div id="process-result" class="result-message"></div>

        <div id="link-list">
            <table class="table">
                <thead>
                    <tr>
                        <th>URL</th>
                        <th>Tags</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="link-tbody">
                    {% for link in links %}
                    {% include '_link_row.html' %}
                    {% endfor %}
                </tbody>
            </table>
            {% if not links %}
            <p class="empty-state">No links in queue. Add one above!</p>
            {% endif %}
        </div>
    </div>
</div>

<div id="error-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <button onclick="hideErrorModal()" class="modal-close">&times;</button>
        <h3>Error Details</h3>
        <div id="error-modal-content"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showErrorModal() {
    document.getElementById('error-modal').style.display = 'flex';
}
function hideErrorModal() {
    document.getElementById('error-modal').style.display = 'none';
}

function processNextLink() {
    const btn = document.getElementById('process-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressLog = document.getElementById('progress-log');
    const progressUrl = document.getElementById('progress-url');
    const progressStatus = document.getElementById('progress-status');
    const resultDiv = document.getElementById('process-result');

    btn.disabled = true;
    btn.textContent = 'Processing...';
    progressContainer.style.display = 'block';
    progressLog.innerHTML = '';
    progressUrl.textContent = '';
    progressStatus.textContent = 'Starting...';
    resultDiv.innerHTML = '';

    const eventSource = new EventSource('/api/links/process/stream');

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === 'start') {
            progressUrl.textContent = data.url;
            progressStatus.textContent = 'Processing';
        } else if (data.type === 'progress') {
            const line = document.createElement('div');
            line.className = 'progress-line';
            line.textContent = data.message;
            progressLog.appendChild(line);
            progressLog.scrollTop = progressLog.scrollHeight;

            const msg = data.message;
            if (msg.includes('Fetching')) progressStatus.textContent = 'Fetching content...';
            else if (msg.includes('Generating summary')) progressStatus.textContent = 'Generating summary...';
            else if (msg.includes('Suggesting')) progressStatus.textContent = 'Suggesting tags...';
            else if (msg.includes('Building')) progressStatus.textContent = 'Building site...';
            else if (msg.includes('Committing')) progressStatus.textContent = 'Pushing to git...';
            else if (msg.includes('Verifying')) progressStatus.textContent = 'Verifying deployment...';
            else if (msg.includes('Checking deployment')) progressStatus.textContent = 'Waiting for deploy...';
        } else if (data.type === 'complete') {
            eventSource.close();
            btn.disabled = false;
            btn.textContent = 'Process Next Link';

            if (data.success) {
                progressStatus.textContent = 'Complete!';
                progressStatus.className = 'progress-status success';
                resultDiv.innerHTML = '<span class="success-message">Link processed successfully!</span>';
                setTimeout(() => location.reload(), 2000);
            } else {
                progressStatus.textContent = 'Failed';
                progressStatus.className = 'progress-status error';
                resultDiv.innerHTML = '<span class="error-message">Processing failed: ' + (data.error || 'Unknown error') + '</span>';
            }
        } else if (data.type === 'error') {
            eventSource.close();
            btn.disabled = false;
            btn.textContent = 'Process Next Link';
            progressStatus.textContent = 'Error';
            progressStatus.className = 'progress-status error';
            resultDiv.innerHTML = '<span class="error-message">' + data.message + '</span>';
            if (data.message === 'No pending links') {
                progressContainer.style.display = 'none';
            }
        }
    };

    eventSource.onerror = function() {
        eventSource.close();
        btn.disabled = false;
        btn.textContent = 'Process Next Link';
        progressStatus.textContent = 'Connection lost';
        progressStatus.className = 'progress-status error';
    };
}
</script>
{% endblock %}
